#!/usr/bin/env ruby

require_relative '../config/environment'

#Whatsapp.send_message '5511962429421@c.us', '_teste2_'

ENV['CHAT_ID'] = Subscriber.find(Sequel.like :name, "%#{ENV['CHAT_NAME']}%")&.chat_id if ENV['CHAT_NAME']

sender = Sender.new
update = ENV['UPDATE']&.in? %w[1 true]

if chat_id = ENV['CHAT_ID']
  if last = ENV['SET_LAST_TEXT']
    pp sender.set_last_from_text  chat_id, last
  elsif last = ENV['SET_LAST_INDEX']&.to_i
    pp sender.set_last_from_index chat_id, last
  elsif ENV['TEST']
    sender.test chat_id, last_text: ARGV[0], update: update
  else
    sender.send chat_id, last_text: ARGV[0], update: update
  end
else
  Sender.load_all
  sender.send_enabled update: update
end

